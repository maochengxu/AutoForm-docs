---
layout: default
title: Production
parent: Backend (Django)
nav_order: 2
---

# Backend

## Production

There are several reminders when putting the backend in a production environment.

### 1. Static files

Always collect the static files before first deployment. The path for static files is in `settings/base.py`:

```python
STATIC_ROOT = os.path.join(BASE_DIR, 'collected_static')
```

### 2. Settings

The settings are divided into 3 parts: `base.py`, `dev.py` and `prod.py`.

-`base.py`: The basic settings that do not need to be distinct between dev and production.
-`dev.py`: The settings that are used in a development environment.
-`prod.py`: The settings that are used in a production environment.

To specify the setting, use a environment variable. In Linux (Debian 11), the environment variable is set in the `gunicorn.service` file of gunicorn:

```
[Service]
// Other settings
Environment="DJANGO_SETTINGS_MODULE=backend.settings.prod"
```

{: .warning }
Always keep the secret keys away from version control (Git), including the username/password of the database connection, the Django secret key and the Monday.com API key!!!

The secret keys are also stored in the same place with environment variables.

```
[Service]
// Other settings
Environment="DJANGO_SECRET_KEY='xxxxxxxxxx'"
Environment="DJANGO_DB_USER=xxxxx"
Environment="DJANGO_DB_PASSWORD=xxxxx"
```

In the production settings, remember to set the following:
```python
DEBUG = False
ALLOWED_HOSTS = ['*']
```

### 3. Security

For the Cross-Origin Resource Sharing (CORS) policy, the `corsheaders` package is used. The settings are in `settings/base.py`:

```python
CORS_ALLOW_CREDENTIALS = True

CORS_ORIGIN_WHITELIST = (
    'http://localhost:5173',
    ... # Other addresses
)

CORS_ALLOW_HEADERS = list(default_headers) + [
    'X-CSRFToken',
]

CSRF_TRUSTED_ORIGINS = [
    'http://localhost:5173',
    ... # Other addresses
]

# Optional
CORS_ALLOWED_ORIGINS = [
    'http://localhost:5173',
    ... # Other addresses
]
```

Cross Site Request Forgery (CSRF) is enabled by default. The token is generated by Django and in our case should be sent to the frontend through REST API. The frontend then sends it back to the backend in the header of the requests. The backend will check the token in the header. If they are the same, the request will be accepted.

In `backend/betterform/views.py`:

```python
from django.middleware.csrf import get_token
from django.http import JsonResponse

def get_csrf_token(request) -> JsonResponse:
    """Get the csrf token from django
    """
    csrf_token = get_token(request)
    return JsonResponse({"csrfToken": csrf_token})
```